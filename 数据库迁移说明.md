# 数据库迁移说明
## 版本 1.3 - 阅读计时功能

本次迁移新增阅读计时相关表与接口。

### 结构变更
- 新增表：`reading_sessions`
  - 字段：id, user_id, book_id, start_time, end_time, duration_seconds, note, created_at

### 迁移步骤（SQLite）
1. 无需手写 SQL，后端启动时会 `Base.metadata.create_all` 自动创建缺失表。
2. 如需在生产环境安全执行，建议先备份数据库：
   ```bash
   cp backend/books.db backend/books_backup_$(date +%Y%m%d_%H%M%S).db
   ```
3. 启动后端：
   ```bash
   cd backend
   uvicorn main:app --host 0.0.0.0 --port 8000 --reload
   ```
4. 验证表是否存在：
   ```sql
   SELECT name FROM sqlite_master WHERE type='table' AND name='reading_sessions';
   ```

### 回滚方案
- 直接回滚数据库文件：将备份的 `books_backup_*.db` 覆盖为 `books.db`。

### 注意事项
- 若后续改为使用 Alembic 进行迁移，请补充对应的迁移脚本与版本号。

## 📋 概述

已将多个分散的数据库迁移脚本合并为一个统一的迁移脚本 `backend/migrate.py`，简化了数据库管理。

## 🔄 迁移内容

### 迁移1: 创建用户系统
- 创建 `users` 表
- 创建默认管理员用户
- 管理员账号: `admin` / `admin123`

### 迁移2: 添加owner_id字段
- 在 `books` 表添加 `owner_id` 字段
- 将现有图书分配给管理员用户

### 迁移3: 添加review字段
- 在 `books` 表添加 `review` 字段（用户评价）

### 迁移4: 添加用户个人资料字段
- `nickname` - 昵称
- `avatar` - 头像
- `gender` - 性别
- `age` - 年龄
- `bio` - 个人简介
- `location` - 所在地

### 迁移5: 添加AI洞察缓存字段
- `ai_insights` - AI阅读洞察缓存

## 🚀 使用方法

### 运行迁移
```bash
cd backend
python migrate.py
```

### 迁移特点
- **智能检测**: 自动检测当前数据库状态
- **增量迁移**: 只执行必要的迁移步骤
- **安全可靠**: 检查字段是否已存在，避免重复操作
- **详细日志**: 显示每个迁移步骤的执行情况

## 📊 迁移状态

脚本会自动检测以下状态：
- `new` - 全新数据库
- `no_users` - 无用户表
- `no_owner_id` - 无owner_id字段
- `no_review` - 无review字段
- `no_profile` - 无用户资料字段
- `no_ai_insights` - 无AI洞察字段
- `complete` - 迁移完成

## ✅ 已删除的文件

以下旧的迁移文件已被删除：
- `migrate_database.py`
- `migrate_to_user_system.py`
- `migrate_user_profile.py`
- `migrate_ai_insights.py`

## 🔧 技术细节

- 使用SQLAlchemy和原生SQLite操作
- 支持事务回滚
- 兼容现有数据
- 自动处理字段冲突

---

**现在只需要一个 `migrate.py` 文件就能完成所有数据库迁移操作！**

# æ•°æ®åº“è¿ç§»è¯´æ˜
## ç‰ˆæœ¬ 1.3 - é˜…è¯»è®¡æ—¶åŠŸèƒ½

æœ¬æ¬¡è¿ç§»æ–°å¢é˜…è¯»è®¡æ—¶ç›¸å…³è¡¨ä¸æ¥å£ã€‚

### ç»“æ„å˜æ›´
- æ–°å¢è¡¨ï¼š`reading_sessions`
  - å­—æ®µï¼šid, user_id, book_id, start_time, end_time, duration_seconds, note, created_at

### è¿ç§»æ­¥éª¤ï¼ˆSQLiteï¼‰
1. æ— éœ€æ‰‹å†™ SQLï¼Œåç«¯å¯åŠ¨æ—¶ä¼š `Base.metadata.create_all` è‡ªåŠ¨åˆ›å»ºç¼ºå¤±è¡¨ã€‚
2. å¦‚éœ€åœ¨ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ‰§è¡Œï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®åº“ï¼š
   ```bash
   cp backend/books.db backend/books_backup_$(date +%Y%m%d_%H%M%S).db
   ```
3. å¯åŠ¨åç«¯ï¼š
   ```bash
   cd backend
   uvicorn main:app --host 0.0.0.0 --port 8000 --reload
   ```
4. éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨ï¼š
   ```sql
   SELECT name FROM sqlite_master WHERE type='table' AND name='reading_sessions';
   ```

### å›æ»šæ–¹æ¡ˆ
- ç›´æ¥å›æ»šæ•°æ®åº“æ–‡ä»¶ï¼šå°†å¤‡ä»½çš„ `books_backup_*.db` è¦†ç›–ä¸º `books.db`ã€‚

### æ³¨æ„äº‹é¡¹
- è‹¥åç»­æ”¹ä¸ºä½¿ç”¨ Alembic è¿›è¡Œè¿ç§»ï¼Œè¯·è¡¥å……å¯¹åº”çš„è¿ç§»è„šæœ¬ä¸ç‰ˆæœ¬å·ã€‚

## ğŸ“‹ æ¦‚è¿°

å·²å°†å¤šä¸ªåˆ†æ•£çš„æ•°æ®åº“è¿ç§»è„šæœ¬åˆå¹¶ä¸ºä¸€ä¸ªç»Ÿä¸€çš„è¿ç§»è„šæœ¬ `backend/migrate.py`ï¼Œç®€åŒ–äº†æ•°æ®åº“ç®¡ç†ã€‚

## ğŸ”„ è¿ç§»å†…å®¹

### è¿ç§»1: åˆ›å»ºç”¨æˆ·ç³»ç»Ÿ
- åˆ›å»º `users` è¡¨
- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
- ç®¡ç†å‘˜è´¦å·: `admin` / `admin123`

### è¿ç§»2: æ·»åŠ owner_idå­—æ®µ
- åœ¨ `books` è¡¨æ·»åŠ  `owner_id` å­—æ®µ
- å°†ç°æœ‰å›¾ä¹¦åˆ†é…ç»™ç®¡ç†å‘˜ç”¨æˆ·

### è¿ç§»3: æ·»åŠ reviewå­—æ®µ
- åœ¨ `books` è¡¨æ·»åŠ  `review` å­—æ®µï¼ˆç”¨æˆ·è¯„ä»·ï¼‰

### è¿ç§»4: æ·»åŠ ç”¨æˆ·ä¸ªäººèµ„æ–™å­—æ®µ
- `nickname` - æ˜µç§°
- `avatar` - å¤´åƒ
- `gender` - æ€§åˆ«
- `age` - å¹´é¾„
- `bio` - ä¸ªäººç®€ä»‹
- `location` - æ‰€åœ¨åœ°

### è¿ç§»5: æ·»åŠ AIæ´å¯Ÿç¼“å­˜å­—æ®µ
- `ai_insights` - AIé˜…è¯»æ´å¯Ÿç¼“å­˜

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œè¿ç§»
```bash
cd backend
python migrate.py
```

### è¿ç§»ç‰¹ç‚¹
- **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å½“å‰æ•°æ®åº“çŠ¶æ€
- **å¢é‡è¿ç§»**: åªæ‰§è¡Œå¿…è¦çš„è¿ç§»æ­¥éª¤
- **å®‰å…¨å¯é **: æ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ“ä½œ
- **è¯¦ç»†æ—¥å¿—**: æ˜¾ç¤ºæ¯ä¸ªè¿ç§»æ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ

## ğŸ“Š è¿ç§»çŠ¶æ€

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹çŠ¶æ€ï¼š
- `new` - å…¨æ–°æ•°æ®åº“
- `no_users` - æ— ç”¨æˆ·è¡¨
- `no_owner_id` - æ— owner_idå­—æ®µ
- `no_review` - æ— reviewå­—æ®µ
- `no_profile` - æ— ç”¨æˆ·èµ„æ–™å­—æ®µ
- `no_ai_insights` - æ— AIæ´å¯Ÿå­—æ®µ
- `complete` - è¿ç§»å®Œæˆ

## âœ… å·²åˆ é™¤çš„æ–‡ä»¶

ä»¥ä¸‹æ—§çš„è¿ç§»æ–‡ä»¶å·²è¢«åˆ é™¤ï¼š
- `migrate_database.py`
- `migrate_to_user_system.py`
- `migrate_user_profile.py`
- `migrate_ai_insights.py`

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

- ä½¿ç”¨SQLAlchemyå’ŒåŸç”ŸSQLiteæ“ä½œ
- æ”¯æŒäº‹åŠ¡å›æ»š
- å…¼å®¹ç°æœ‰æ•°æ®
- è‡ªåŠ¨å¤„ç†å­—æ®µå†²çª

---

**ç°åœ¨åªéœ€è¦ä¸€ä¸ª `migrate.py` æ–‡ä»¶å°±èƒ½å®Œæˆæ‰€æœ‰æ•°æ®åº“è¿ç§»æ“ä½œï¼**

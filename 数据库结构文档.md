# 书云系统数据库结构文档

## 概述
本文档详细记录了书云图书管理系统的数据库结构，包括所有表、字段、索引和关系。

## 数据库文件
- 位置：`backend/books.db`
- 类型：SQLite 3
- 字符编码：UTF-8

## 表结构

### 1. users 表 - 用户信息表

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | - | 用户唯一标识 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | - | 用户名 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | - | 邮箱地址 |
| hashed_password | VARCHAR(255) | NOT NULL | - | 加密后的密码 |
| is_active | BOOLEAN | - | TRUE | 账户是否激活 |
| is_admin | BOOLEAN | - | FALSE | 是否为管理员 |
| membership_status | VARCHAR(20) | - | 'FREE' | 会员状态 |
| membership_expires_at | DATETIME | - | NULL | 会员到期时间 |
| can_use_system | BOOLEAN | - | TRUE | 是否有使用系统权限 |
| nickname | VARCHAR(50) | - | NULL | 昵称 |
| avatar | VARCHAR(500) | - | NULL | 头像URL |
| gender | VARCHAR(10) | - | NULL | 性别 |
| age | INTEGER | - | NULL | 年龄 |
| bio | TEXT | - | NULL | 个人简介 |
| location | VARCHAR(100) | - | NULL | 所在地 |
| ai_insights | TEXT | - | NULL | AI阅读洞察缓存 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NULL | 更新时间 |

#### 会员状态枚举值
- `FREE`: 免费用户
- `MONTHLY`: 月费会员
- `YEARLY`: 年费会员
- `LIFETIME`: 终身会员

#### 索引
- `idx_users_username`: username字段索引
- `idx_users_email`: email字段索引

### 2. books 表 - 图书信息表

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | - | 图书唯一标识 |
| title | VARCHAR(200) | NOT NULL | - | 书名 |
| author | VARCHAR(100) | NOT NULL | - | 作者 |
| published_date | DATE | - | NULL | 出版日期 |
| cover_image | VARCHAR(500) | - | NULL | 封面图片路径 |
| description | TEXT | - | NULL | 图书描述 |
| category | VARCHAR(50) | - | NULL | 分类 |
| review | TEXT | - | NULL | 用户评论心得 |
| status | ENUM | - | 'UNREAD' | 阅读状态 |
| owner_id | INTEGER | FOREIGN KEY, NOT NULL | - | 图书所有者ID |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NULL | 更新时间 |

#### 阅读状态枚举值
- `READ`: 已读
- `UNREAD`: 未读

#### 外键关系
- `owner_id` → `users.id`

#### 索引
- `idx_books_title`: title字段索引
- `idx_books_author`: author字段索引
- `idx_books_category`: category字段索引
- `idx_books_owner_id`: owner_id字段索引

### 3. payments 表 - 支付记录表

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | - | 支付记录唯一标识 |
| user_id | INTEGER | FOREIGN KEY, NOT NULL | - | 用户ID |
| amount | DECIMAL(10,2) | NOT NULL | - | 支付金额 |
| payment_type | VARCHAR(20) | NOT NULL | - | 支付类型 |
| status | ENUM | - | 'PENDING' | 支付状态 |
| payment_method | VARCHAR(20) | - | NULL | 支付方式 |
| transaction_id | VARCHAR(100) | - | NULL | 交易ID |
| qr_code_url | VARCHAR(500) | - | NULL | 支付二维码URL |
| paid_at | DATETIME | - | NULL | 支付时间 |
| expires_at | DATETIME | - | NULL | 支付过期时间 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NULL | 更新时间 |

#### 支付类型枚举值
- `monthly`: 月费
- `yearly`: 年费

#### 支付状态枚举值
- `PENDING`: 待支付
- `PAID`: 已支付
- `EXPIRED`: 已过期
- `CANCELLED`: 已取消

#### 支付方式枚举值
- `wechat`: 微信支付
- `alipay`: 支付宝

#### 外键关系
- `user_id` → `users.id`

#### 索引
- `idx_payments_user_id`: user_id字段索引
- `idx_payments_status`: status字段索引
- `idx_payments_created_at`: created_at字段索引

### 4. reading_sessions 表 - 阅读计时会话表（v1.3 新增）

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | - | 会话唯一标识 |
| user_id | INTEGER | FOREIGN KEY, NOT NULL, INDEX | - | 所属用户ID（关联 users.id） |
| book_id | INTEGER | FOREIGN KEY, NOT NULL, INDEX | - | 所属图书ID（关联 books.id） |
| start_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 会话开始时间 |
| end_time | DATETIME | NULL | NULL | 会话结束时间 |
| duration_seconds | INTEGER | NULL | NULL | 本次阅读时长（秒，停止后写入） |
| note | TEXT | NULL | NULL | 本次阅读笔记 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

#### 外键关系
- `user_id` → `users.id`
- `book_id` → `books.id`

#### 说明
- 开始计时即写入记录；停止计时写入 `end_time` 与 `duration_seconds`。
- 今日时长与总时长通过对该表聚合计算。

## 表关系图

```
users (1) ←→ (N) books
  |
  | (1)
  |
  v
payments (N)
```

## 数据迁移历史

### 版本 1.0 - 初始版本
- 创建 users 表（基础字段）
- 创建 books 表

### 版本 1.1 - 用户资料扩展
- 添加用户个人资料字段：nickname, avatar, gender, age, bio, location, ai_insights

### 版本 1.2 - 权限管理和充值系统
- 添加会员相关字段：membership_status, membership_expires_at, can_use_system
- 创建 payments 表
- 添加相关索引

### 版本 1.3 - 阅读计时功能
- 新增 reading_sessions 表
- 新增相关 API：/reading/start, /reading/stop, /reading/stats/{book_id}

## 数据库维护

### 备份
```bash
# 备份数据库
cp backend/books.db backend/books_backup_$(date +%Y%m%d_%H%M%S).db
```

### 恢复
```bash
# 恢复数据库
cp backend/books_backup_YYYYMMDD_HHMMSS.db backend/books.db
```

### 迁移脚本
- 位置：`backend/migrate_permissions.py`
- 用途：添加权限管理和充值系统相关字段和表

### 常用查询

#### 检查表结构
```sql
PRAGMA table_info(table_name);
```

#### 查看所有表
```sql
SELECT name FROM sqlite_master WHERE type='table';
```

#### 查看索引
```sql
SELECT name FROM sqlite_master WHERE type='index';
```

## 注意事项

1. **字段添加**：SQLite不支持删除列，只能添加列
2. **外键约束**：确保外键引用的表存在
3. **索引维护**：定期检查索引使用情况
4. **数据备份**：重要操作前务必备份数据库
5. **版本控制**：数据库结构变更需要记录版本号

## 联系信息
如有数据库相关问题，请联系系统管理员。
